version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: home-transmission-openvpn_transmission-openvpn_1
      APP_PORT: 9091
    container_name: home-transmission-openvpn_app_proxy_1

  # Transmission + OpenVPN
  transmission-openvpn:
    image: haugene/transmission-openvpn:latest
    restart: on-failure
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    dns:
      - 1.1.1.1
      - 1.0.0.1
    logging:
      driver: json-file
      options:
        max-size: 10m
    environment:
      # VPN provider — set to CUSTOM to use your own .ovpn file
      # NordVPN users: set NORDVPN_PROTOCOL=udp (TCP times out on Umbrel Docker network)
      OPENVPN_PROVIDER: "CUSTOM"
      OPENVPN_CONFIG: ""
      OPENVPN_USERNAME: ""
      OPENVPN_PASSWORD: ""

      # Umbrel Docker subnet — required so Radarr/Sonarr can reach RPC
      LOCAL_NETWORK: "10.21.0.0/16"

      # Transmission settings
      TRANSMISSION_DOWNLOAD_DIR: "/downloads/complete"
      TRANSMISSION_INCOMPLETE_DIR: "/downloads/incomplete"
      TRANSMISSION_INCOMPLETE_DIR_ENABLED: "true"
      TRANSMISSION_WATCH_DIR: "/downloads/watch"
      TRANSMISSION_WATCH_DIR_ENABLED: "true"

      # RPC — allow connections from the Docker network
      TRANSMISSION_RPC_AUTHENTICATION_REQUIRED: "false"
      TRANSMISSION_RPC_HOST_WHITELIST_ENABLED: "false"
      TRANSMISSION_RPC_WHITELIST_ENABLED: "false"

      # Performance defaults
      TRANSMISSION_SPEED_LIMIT_UP: "100"
      TRANSMISSION_SPEED_LIMIT_UP_ENABLED: "false"
      TRANSMISSION_RATIO_LIMIT: "2"
      TRANSMISSION_RATIO_LIMIT_ENABLED: "false"

      TRANSMISSION_PEER_PORT: "51820"
      CREATE_TUN_DEVICE: "true"
      HEALTH_CHECK_HOST: "google.com"
      PUID: "1000"
      PGID: "1000"
      LOG_TO_STDOUT: "true"
      TZ: "UTC"

    volumes:
      - ${APP_DATA_DIR}/data/config:/config
      - ${UMBREL_ROOT}/data/storage/downloads:/downloads
      # Place your .ovpn file(s) in APP_DATA_DIR/data/openvpn/ and set OPENVPN_CONFIG
      - ${APP_DATA_DIR}/data/openvpn:/etc/openvpn/custom

    ports:
      - "51820:51820"
      - "51820:51820/udp"
